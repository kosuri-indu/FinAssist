<aside
    class="sidebar fixed top-0 left-0 h-full bg-gray-800 text-white p-6 flex flex-col justify-between z-20 shadow-xl w-72">
    <div>
        <div class="text-2xl font-extrabold text-[#38A169] mb-8 tracking-wider">FinAssist</div>
        <nav class="space-y-3">
            <a href="/dashboard"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="dashboard">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                Dashboard
            </a>
            <a href="/add"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="add">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Data
            </a>
            <a href="/transactions"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="transactions">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                Transactions
            </a>
            <a href="/chat"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="chat">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.97-4.03 9-9 9a9.003 9.003 0 01-4.472-1.144L3 21l1.144-4.528A9.003 9.003 0 013 12c0-4.97 4.03-9 9-9s9 4.03 9 9z">
                    </path>
                </svg>
                Chat
            </a>
            <a href="/invest"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="invest">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3v18h18M7 13l3-3 4 4 5-5" />
                </svg>

                Investment Assistant
            </a>
            <a href="/notifications"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="notifications">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                Notifications
            </a>
            <a href="/agents"
                class="nav-link flex items-center p-2 rounded-lg text-sm hover:bg-gray-700 transition duration-150"
                data-page="agents">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5h6M11 9h6m-6 4h6M5 6h.01M5 10h.01M5 14h.01" />
                </svg>
                Agents Center
            </a>
        </nav>
    </div>
    <div class="mt-6">
        <a href="/logout"
            class="flex items-center p-2 rounded-lg text-sm text-red-400 hover:bg-gray-700 transition duration-150">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                </path>
            </svg>
            Logout
        </a>
    </div>
</aside>

<script>
    // SPA-like sidebar navigation: intercept nav-link clicks and load main content via fetch
    (function () {
        const navLinks = Array.from(document.querySelectorAll('.nav-link'));
        const mainSelector = 'main.main-content';

        function normalizePath(href) {
            try {
                const p = new URL(href, location.origin).pathname;
                return (p.endsWith('/') && p !== '/') ? p.slice(0, -1) : p;
            } catch (e) {
                return href;
            }
        }

        function setActive(link) {
            navLinks.forEach(l => { l.classList.remove('bg-green-600', 'text-white'); l.classList.add('hover:bg-gray-700'); });
            if (link) { link.classList.add('bg-green-600', 'text-white'); link.classList.remove('hover:bg-gray-700'); }
        }

        async function loadHref(href, push = true) {
            try {
                const res = await fetch(href, { credentials: 'same-origin' });
                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const newMain = doc.querySelector(mainSelector);
                const curMain = document.querySelector(mainSelector);
                if (newMain && curMain) {
                    curMain.innerHTML = newMain.innerHTML;
                    // update the document title if provided
                    const newTitle = doc.querySelector('title');
                    if (newTitle) document.title = newTitle.textContent;
                    if (push) history.pushState({ path: href }, '', href);
                    // set active link for the loaded href
                    const targetPath = normalizePath(href);
                    const matched = navLinks.find(l => normalizePath(l.getAttribute('href') || l.href) === targetPath);
                    setActive(matched || null);
                    // run optional page init hook
                    if (typeof window.onPageLoad === 'function') {
                        try { window.onPageLoad(); } catch (e) { console.warn('onPageLoad error', e); }
                    }
                    return true;
                } else {
                    // fallback to full navigation when fragment not found
                    window.location.href = href;
                    return false;
                }
            } catch (e) {
                console.error('Navigation failed, falling back to full load', e);
                window.location.href = href;
                return false;
            }
        }

        navLinks.forEach(link => {
            // don't intercept logout or links opting out
            const href = link.getAttribute('href');
            if (!href || href.startsWith('http') || href.startsWith('#')) return;
            if (href.startsWith('/logout') || link.hasAttribute('data-no-ajax')) return;
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                setActive(link);
                loadHref(href, true);
            });
        });

        // handle back/forward
        window.addEventListener('popstate', (ev) => {
            const path = window.location.pathname + window.location.search;
            loadHref(path, false).then(() => {
                // update active link on pop
                const pathNow = normalizePath(window.location.pathname);
                const match = navLinks.find(l => normalizePath(l.getAttribute('href') || l.href) === pathNow);
                setActive(match || null);
            });
        });

        // initial active link based on path
        (function markInitial() {
            const path = normalizePath(window.location.pathname);
            const match = navLinks.find(l => {
                const lh = normalizePath(l.getAttribute('href') || l.href);
                return path === lh || path.startsWith(lh);
            });
            setActive(match || null);
        })();
    })();
</script>