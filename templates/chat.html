<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
  <!-- Markdown renderer and sanitizer for assistant replies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <style>
    /* Simple chat bubble styles */
    html, body { height: 100%; }
    /* Make chat window a fixed height so card doesn't fill entire viewport */
    .chat-window { height: 60vh; overflow-y: auto; padding: 1rem; display:flex; flex-direction:column; gap:0.75rem; }
    .bubble { max-width: 80%; padding: .6rem .8rem; border-radius: .75rem; }
    .bubble.user { margin-left: auto; background: #1F2937; color: white; border-bottom-right-radius: .25rem; }
    /* Assistant reply bubble: green background, black text (as requested). */
    .bubble.ai { margin-right: auto; background: #e6ffea; color: #000; border-bottom-left-radius: .25rem; }
    /* Allow rendered HTML inside AI bubbles to wrap nicely */
    .bubble.ai p { margin: 0 0 0.5rem 0; color: inherit; }
    .bubble.ai table { border-collapse: collapse; width: 100%; }
    .bubble.ai th, .bubble.ai td { border: 1px solid #d1fae5; padding: 6px 8px; text-align: left; }
    .bubble.ai th { background:#f0fff4; font-weight:600; }
  </style>
 </head>
<body>
    {% include 'sidebar.html' %}

    <main class="main-content ml-72 p-8">
        <header class="mb-4">
          <h1 class="text-3xl font-extrabold text-gray-900">Assistant Chat</h1>
          <p class="text-sm text-gray-600">Ask questions about your finances or transactions.</p>
        </header>

        <div class="bg-white rounded-lg shadow p-4 flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-700">Model: <strong class="text-gray-900">gpt-4.1-mini</strong></div>
            <div class="text-xs text-gray-500">Connected</div>
          </div>

          <div id="chat-window" class="chat-window bg-gray-50 rounded-lg">
            <!-- messages will appear here -->
            <div class="bubble ai">Hello there, I am here to  help you summarize your spending or transactions.</div>
          </div>

          <form id="chat-form" class="mt-4 flex gap-3 items-end">
            <textarea id="chat-input" rows="1" placeholder="Type a message or add: 'Spent 200 on groceries'" class="flex-1 border rounded px-3 py-2 resize-none"></textarea>
            <button id="send-btn" class="bg-indigo-600 text-white px-4 py-2 rounded">Send</button>
          </form>
        </div>
      </div>
    </main>

    <script>
      const form = document.getElementById('chat-form');
      const input = document.getElementById('chat-input');
      const windowEl = document.getElementById('chat-window');

      function appendMessage(text, who, isHtml=false){
        const el = document.createElement('div');
        el.className = 'bubble ' + (who === 'user' ? 'user' : 'ai');
        if(isHtml && who !== 'user'){
          // Render markdown -> HTML and sanitize before inserting
          try{
            const raw = marked.parse(text || '');
            el.innerHTML = DOMPurify.sanitize(raw);
          }catch(e){
            el.textContent = text;
          }
        }else{
          el.textContent = text;
        }
        windowEl.appendChild(el);
        windowEl.scrollTop = windowEl.scrollHeight;
        return el;
      }

      async function sendMessage(){
        const v = input.value.trim();
        if(!v) return;
        appendMessage(v, 'user');
        input.value = '';

        // quick heuristic: if message starts with "spent" or contains a number + category, send to quick-add endpoint
        const lower = v.toLowerCase();
        if(lower.startsWith('spent') || /\d+/.test(lower) && /(on|for)/.test(lower)){
          // POST to quick add endpoint (non-blocking); fallback to mock response
          try{
            await fetch('/transactions/quick', { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({text: v}) });
            appendMessage('Added as a quick transaction (sent to server).', 'ai');
          }catch(err){
            appendMessage('Unable to reach server — saved locally (mock).', 'ai');
          }
          return;
        }

        // send message to server and show reply
        const thinkingEl = appendMessage('Thinking…', 'ai', false);

        try{
          const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({message: v}) });
          const body = await res.json();
          if(res.ok && body.reply){
            // Render assistant reply as sanitized markdown inside the same bubble
            try{
              const rendered = marked.parse(body.reply || '');
              thinkingEl.innerHTML = DOMPurify.sanitize(rendered);
            }catch(e){
              thinkingEl.textContent = body.reply;
            }
          }else if(body.error){
            thinkingEl.textContent = 'Error: ' + body.error;
          }else{
            thinkingEl.textContent = 'No reply from server.';
          }
        }catch(err){
          thinkingEl.textContent = 'Unable to reach chat server.';
        }
        windowEl.scrollTop = windowEl.scrollHeight;
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        await sendMessage();
      });

      // Send on Enter (no Shift) from the textarea
      input.addEventListener('keydown', async (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          await sendMessage();
        }
      });
    </script>
</body>
</html>
