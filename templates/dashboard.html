<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Ä¢ FinAssist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
  <style>
    /* Improved dashboard styling */
    body { overflow-x: hidden; }
    .dashboard-container { width: calc(100vw - 18rem); max-width: calc(100vw - 18rem); box-sizing: border-box; }
    
    /* Enhanced card styling with better shadows and spacing */
    .card { 
      background: white; 
      border-radius: 0.75rem; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.03); 
      display: flex; 
      flex-direction: column;
      border: 1px solid rgba(0,0,0,0.02);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.3px;
    }
    
    .metric-box {
      padding: 1.25rem;
      background: #fafafa;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    
    .metric-box:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    
    .metric-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
    }
    
    .muted { color: #6b7280; font-size: 0.875rem; }
    .sparkline { width: 100%; height: 36px; }
    .scroll-area { max-height: calc(100vh - 140px); overflow: auto; }
    
    /* Color utilities */
    .text-expense { color: #dc2626; }
    .text-income { color: #16a34a; }
    .text-net { color: #2563eb; }
    .text-warning { color: #f97316; }
    
    .bg-expense { background-color: #fef2f2; border-color: #fee2e2; }
    .bg-income { background-color: #f0fdf4; border-color: #dbeafe; }
    .bg-net { background-color: #eff6ff; border-color: #dbeafe; }
    
    /* Better spacing for lists */
    .list-item {
      padding: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    /* Category breakdown */
    .category-item {
      padding: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .category-bar {
      flex: 1;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      margin: 0 1rem;
      overflow: hidden;
    }
    
    .category-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 3px;
    }
    
    .category-amount {
      text-align: right;
      font-weight: 600;
      min-width: 80px;
    }
    
    /* Bill item styling */
    .bill-item {
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      background: white;
    }
    
    .bill-item:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      transform: translateX(2px);
    }
    
    .bill-item.urgent {
      border-left: 4px solid #dc2626;
      background: #fef2f2;
    }
    
    .bill-item.today {
      border-left: 4px solid #f97316;
      background: #fff7ed;
    }
    
    .bill-item.normal {
      border-left: 4px solid #10b981;
    }
    
    .bill-info {
      flex: 1;
      min-width: 0;
    }
    
    .bill-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    
    .bill-due {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .bill-priority {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background: #f0f0f0;
      margin-left: 1rem;
      white-space: nowrap;
    }
    
    .bill-amount {
      text-align: right;
      margin-left: 1rem;
      font-weight: 700;
      font-size: 1.1rem;
      min-width: 90px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  {% include 'sidebar.html' %}

  <header class="fixed top-0 left-72 right-0 bg-white border-b z-20">
    <div class="max-w-7xl mx-auto px-3 py-3 flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-500">Welcome, <span class="font-semibold">{{ session.get('user_email') or 'Friend' }}</span></div>
        <div class="flex items-center gap-2">
          <div class="text-xs text-gray-400" id="dashboard-date"></div>
          <button id="dashboard-refresh" title="Refresh dashboard" class="text-xs px-2 py-1 bg-gray-100 rounded">Refresh</button>
        </div>
      </div>
      <div class="text-right">
        <div class="text-base font-semibold">Dashboard</div>
        <div class="text-sm muted">Your AI-powered financial overview is ready.</div>
      </div>
    </div>
  </header>

  <main class="ml-72 pt-20">
    <div class="dashboard-container mx-auto grid grid-cols-12 gap-6 px-4">
      <!-- Left / Main Scrollable Column -->
      <section class="col-span-9">
        <div class="space-y-6 scroll-area pr-4">

          <!-- AI Insights -->
          <div class="card p-6">
            <div class="card-header">
              <h2>üí° AI Spending Insights</h2>
              <button id="run-insights" class="px-3 py-1.5 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700">Analyze Now</button>
            </div>
            <div id="insights-container" class="space-y-4">
              <div class="text-sm text-gray-500">Loading insights...</div>
            </div>
          </div>

          <!-- Forecast -->
          <div class="card p-6">
            <div class="card-header">
              <h2>üìä AI Financial Forecast</h2>
              <button id="run-forecast" class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700">Forecast Now</button>
            </div>
            <div id="forecast-container" class="space-y-4">
              <div class="text-sm text-gray-500">Generating forecast...</div>
            </div>
          </div>

          <!-- Monthly Summary -->
          <div class="card p-6">
            <div class="card-header">
              <h2>üí∞ Monthly Summary</h2>
              <div class="muted">Current month totals</div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="metric-box bg-expense border-red-200">
                <div class="metric-label">Total Expense</div>
                <div id="sum-expense" class="metric-value text-expense">‚Äî</div>
              </div>
              <div class="metric-box bg-income border-green-200">
                <div class="metric-label">Total Income</div>
                <div id="sum-income" class="metric-value text-income">‚Äî</div>
              </div>
              <div class="metric-box bg-net border-blue-200">
                <div class="metric-label">Net Balance</div>
                <div id="sum-net" class="metric-value text-net">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Category Breakdown and Quick Metrics removed -->
    

          <!-- Recent Transactions -->
          <div class="card p-6">
            <div class="card-header">
              <h2>üßæ Recent Transactions</h2>
              <div class="muted">Last 5 transactions</div>
            </div>
            <div class="space-y-2">
              <table class="w-full text-left text-sm">
                <thead class="text-xs text-gray-500 font-semibold">
                  <tr>
                    <th class="pb-3">Type</th>
                    <th class="pb-3">Category</th>
                    <th class="pb-3">Amount</th>
                    <th class="pb-3">Date</th>
                  </tr>
                </thead>
                <tbody id="recent-txns" class="text-sm"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- Right sticky results column -->
      <aside class="col-span-3">
        <div class="sticky top-20 space-y-4">
          <div class="card p-5">
            <div class="text-sm font-semibold text-gray-800 mb-4">üìä Quick Overview</div>
            <div class="space-y-3">
              <div class="flex justify-between items-center pb-3 border-b">
                <span class="text-sm text-gray-600">Income</span>
                <span id="st-income" class="text-base font-bold text-income">‚Äî</span>
              </div>
              <div class="flex justify-between items-center pb-3 border-b">
                <span class="text-sm text-gray-600">Expenses</span>
                <span id="st-expense" class="text-base font-bold text-expense">‚Äî</span>
              </div>
              <div class="flex justify-between items-center pb-3 border-b">
                <span class="text-sm text-gray-600">Upcoming Bills</span>
                <span id="st-bills" class="text-base font-bold text-warning">‚Äî</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Transactions</span>
                <span id="st-txns" class="text-base font-bold text-gray-700">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="card p-5">
            <div class="text-sm font-semibold text-gray-800 mb-4">üìà Spending Trend</div>
            <svg class="sparkline mt-3" viewBox="0 0 100 36" preserveAspectRatio="none"><polyline id="trendline" fill="none" stroke="#10b981" stroke-width="2.5" points=""></polyline></svg>
            <div class="text-xs text-gray-500 mt-3 text-center">Last 7 days</div>
          </div>

          <div class="card p-5">
            <div class="flex items-center justify-between">
              <div class="text-sm muted">Debug</div>
              <button id="toggle-debug" class="text-xs px-2 py-1 bg-gray-100 rounded">Show API</button>
            </div>
            <pre id="debug-panel" class="mt-3 text-xs overflow-auto" style="max-height:200px;display:none;background:#111827;color:#d1d5db;padding:8px;border-radius:6px;"></pre>
          </div>
        
        </div>
      </aside>

    </div>
  </main>

  <script>
    // No local mock data: dashboard now prefers live DB-driven endpoints.
    // The client will show empty/placeholder values if endpoints are not available.

    // hydrate UI: try to fetch DB-driven endpoints; fall back to mock data when unavailable
    async function fetchJson(url){
      try{
        const r = await fetch(url, {credentials: 'same-origin'});
        if(r.ok){
          const json = await r.json();
          console.log(`‚úÖ API ${url} succeeded:`, json);
          return json;
        }
        // If not ok, log the status
        console.warn(`‚ùå API ${url} returned ${r.status}`, await r.text());
      }catch(e){
        console.warn(`‚ùå API ${url} failed:`, e);
      }
      return null;
    }

    async function loadDashboard(){
      // server endpoints we will try to use (these may be added later):
      // /api/dashboard/summary => { monthly:{income,expense,net}, categories:[...], reminders:{...} }
      // /api/transactions/recent => [{type,category,amount,date}, ...]
      // /api/notifications/json => { notifications: [...] }
      const [summary, recentTxns, notifications] = await Promise.all([
        fetchJson('/api/dashboard/summary'),
        fetchJson('/api/transactions/recent'),
        fetchJson('/api/notifications/json')
      ]);

      const data = summary || {};

      const source = summary ? 'live' : 'mock';

      // Log to debug panel if enabled
      const debugPanel = document.getElementById('debug-panel');
      if(debugPanel){
        debugPanel.innerHTML += `<div>Summary: ${summary ? 'loaded' : 'failed/null'}</div>`;
        debugPanel.innerHTML += `<div>RecentTxns: ${recentTxns ? 'loaded' : 'failed/null'}</div>`;
        debugPanel.innerHTML += `<div>Notifications: ${notifications ? 'loaded' : 'failed/null'}</div>`;
      }
        // Insights & Forecast: prefer live agent results, fall back to mock
        // dashboard time UI: show nice formatted time + "Updated X ago"
        let _lastFetchTime = null;
        function _formatDateTime(d){
          try{
            return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
          }catch(e){
            return d.toString();
          }
        }
        function _timeAgo(d){
          if(!d) return '';
          const s = Math.floor((Date.now() - d.getTime())/1000);
          if(s < 5) return 'just now';
          if(s < 60) return s + 's ago';
          const m = Math.floor(s/60);
          if(m < 60) return m + 'm ago';
          const h = Math.floor(m/60);
          if(h < 24) return h + 'h ago';
          const days = Math.floor(h/24);
          if(days === 1) return 'yesterday';
          return days + 'd ago';
        }

        function updateDashboardDateDisplay(){
          const el = document.getElementById('dashboard-date');
          if(!el) return;
          const now = new Date();
          const ref = _lastFetchTime || now;
          const main = _formatDateTime(ref);
          const rel = _timeAgo(ref);
          el.innerHTML = `<div class="font-medium">${main}</div><div class="text-xs muted">Updated ${rel}</div>`;
        }

        // refresh button handler
        const _refreshBtn = document.getElementById('dashboard-refresh');
        if(_refreshBtn){
          _refreshBtn.addEventListener('click', async function(){
            _refreshBtn.disabled = true;
            _refreshBtn.textContent = 'Refreshing‚Ä¶';
            try{ await loadDashboard(); }catch(e){}
            _refreshBtn.disabled = false;
            _refreshBtn.textContent = 'Refresh';
          });
        }

        // update the displayed relative time every 10 seconds
        setInterval(updateDashboardDateDisplay, 10000);
        let insightsRes = await fetchJson('/api/agents/insights');
        // If no cached insights exist yet, trigger a cached refresh (no AI) and re-fetch so dashboard shows DB-driven insights.
        if(!insightsRes){
          try{
            await fetch('/api/agents/insights/run', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
            insightsRes = await fetchJson('/api/agents/insights');
          }catch(e){ /* ignore */ }
        }
        let forecastRes = await fetchJson('/api/agents/forecast');
        if(!forecastRes){
          try{
            await fetch('/api/agents/forecast/run', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
            forecastRes = await fetchJson('/api/agents/forecast');
          }catch(e){ /* ignore */ }
        }

        // Insights
        const insElTop = document.getElementById('insight-top-category');
        const insElWow = document.getElementById('insight-wow');
        const insElBig = document.getElementById('insight-biggest');
        const insElPattern = document.getElementById('insight-pattern');
        const insElReco = document.getElementById('insight-reco');

        if(insightsRes && insightsRes.result){
          const ins = insightsRes.result;
          // Biggest expense (deterministic or AI-provided)
          const big = ins.biggest_expense || ins.biggest || null;
          if(insElTop){
            if(big){
              const bam = (big.amount_cents || big.amountCents || big.amount || 0)/100;
              const bl = big.label || big.name || '';
              insElTop.textContent = `‚Çπ${bam.toFixed(2)} ‚Ä¢ ${bl}`;
            } else if(ins.raw) {
              insElTop.textContent = ins.raw.slice(0,80) + '...';
            } else {
              insElTop.textContent = '‚Äî';
            }
          }
          if(insElWow){
            const wow = ins.week_over_week_change || ins.week_over_week || ins.wow || null;
            if(wow) insElWow.textContent = wow;
          }
          // Lowest expense (new)
          if(insElBig){
            const low = ins.lowest_expense || ins.lowest || null;
            if(low){
              const lam = (low.amount_cents || low.amountCents || low.amount || 0)/100;
              const ll = low.label || low.name || '';
              insElBig.textContent = `‚Çπ${lam.toFixed(2)} ‚Ä¢ ${ll}`;
            } else {
              insElBig.textContent = '‚Äî';
            }
          }
          if(insElPattern){ if(ins.behavior_pattern) insElPattern.textContent = ins.behavior_pattern; else if(ins.pattern) insElPattern.textContent = ins.pattern; }
          if(insElReco){ if(ins.recommendation) insElReco.textContent = ins.recommendation; else if(ins.reco) insElReco.textContent = ins.reco; }
        } else {
          // No live insights available ‚Äî show neutral placeholders
          if(insElTop) insElTop.textContent = 'No data';
          if(insElWow) insElWow.textContent = '‚Äî';
          if(insElBig) insElBig.textContent = '‚Äî';
          if(insElPattern) insElPattern.textContent = '‚Äî';
          if(insElReco) insElReco.textContent = '‚Äî';
        }

        // Forecast
        const fTotalEl = document.getElementById('forecast-total');
        const fCatsEl = document.getElementById('forecast-cats');
        const fSavingsEl = document.getElementById('forecast-savings');
        const fTrendEl = document.getElementById('forecast-trend');

        if(forecastRes && forecastRes.result){
          const f = forecastRes.result;
          const expC = f.predicted_total_expense_cents || f.predictedTotalExpenseCents || f.predicted_expense_cents || 0;
          const incC = f.predicted_total_income_cents || f.predictedTotalIncomeCents || f.predicted_income_cents || 0;
          if(fTotalEl) fTotalEl.textContent = `Expense: ‚Çπ${(expC/100).toFixed(2)}`;
          if(fCatsEl) fCatsEl.textContent = '';
          if(fSavingsEl) fSavingsEl.textContent = `Income: ‚Çπ${(incC/100).toFixed(2)}`;
          if(fTrendEl && (f.narrative || f.story)) fTrendEl.textContent = f.narrative || f.story;
        } else {
          if(fTotalEl) fTotalEl.textContent = '‚Äî';
          if(fCatsEl) fCatsEl.textContent = '‚Äî';
          if(fSavingsEl) fSavingsEl.textContent = '‚Äî';
          if(fTrendEl) fTrendEl.textContent = '‚Äî';
        }

      // Reminders: Load and display bills beautifully
      async function loadReminders(){
        try{
          const res = await fetch('/api/reminders', {credentials: 'same-origin'});
          if(!res.ok) throw new Error('Failed to load reminders');
          const reminderData = await res.json();
          
          // Update summary
          const msg = reminderData.message || '';
          const details = reminderData.details || {};
          
          document.getElementById('reminder-ai-block').innerHTML = msg || 'No bills data';
          document.getElementById('reminder-total').textContent = `‚Çπ${(details.total_rupees || 0).toFixed(2)}`;
          document.getElementById('reminder-count').textContent = details.count || 0;
          document.getElementById('reminder-overdue-count').textContent = details.overdue_count || 0;
          document.getElementById('reminder-today-count').textContent = details.due_today_count || 0;
          
          // Render bills list
          const billsList = document.getElementById('bills-list');
          const bills = details.bills || [];
          
          if(bills.length === 0){
            billsList.innerHTML = '<div class="text-sm text-gray-500 py-4 text-center">‚úÖ No bills due in next 7 days</div>';
          } else {
            billsList.innerHTML = bills.map(bill => {
              const bgClass = bill.priority && bill.priority.includes('OVERDUE') ? 'urgent' : 
                              bill.priority && bill.priority.includes('DUE TODAY') ? 'today' : 'normal';
              return `
                <div class="bill-item ${bgClass}">
                  <div class="bill-info">
                    <div class="bill-name">${bill.name}</div>
                    <div class="bill-due">${bill.priority || 'üü¢ NORMAL'} ‚Ä¢ Due: ${bill.due_date ? new Date(bill.due_date).toLocaleDateString() : 'N/A'}</div>
                  </div>
                  <div class="bill-priority">${bill.days_until !== null ? (bill.days_until < 0 ? 'Overdue' : bill.days_until + 'd') : 'Soon'}</div>
                  <div class="bill-amount">‚Çπ${bill.amount_rupees.toFixed(0)}</div>
                </div>
              `;
            }).join('');
          }
        }catch(e){
          document.getElementById('bills-list').innerHTML = '<div class="text-sm text-red-500 py-4 text-center">Error loading bills</div>';
        }
      }
      
      // Load reminders on page load
      loadReminders();
      
      // Add refresh button handler
      const runRemindersBtn = document.getElementById('run-reminders');
      if(runRemindersBtn){
        runRemindersBtn.addEventListener('click', loadReminders);
      }

      // Reminders: prefer notifications endpoint; default to empty lists
      let reminders = { ai_text: null, due_today: [], upcoming: [], overdue: [] };
      if(notifications && Array.isArray(notifications.notifications)){
        // transform provider notifications to our simple structure (amount in rupees as number)
        const ns = notifications.notifications;
        const due_today = ns.filter(n=> n.type && n.type.includes('today')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)}));
        const upcoming = ns.filter(n=> n.type && n.type.includes('week')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)}));
        reminders = { ai_text: null, due_today, upcoming, overdue: ns.filter(n=> n.type && n.type.includes('overdue')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)})) };
      }

      // record last successful refresh time and update header display
      try{ _lastFetchTime = new Date(); }catch(e){}
      try{ updateDashboardDateDisplay(); }catch(e){}

      // Monthly summary: prefer summary.monthly
      const monthly = (data && data.monthly) ? data.monthly : null;
      const sumExpenseEl = document.getElementById('sum-expense'); if(sumExpenseEl) sumExpenseEl.textContent = monthly ? `‚Çπ${monthly.expense.toFixed(2)}` : '‚Äî';
      const sumIncomeEl = document.getElementById('sum-income'); if(sumIncomeEl) sumIncomeEl.textContent = monthly ? `‚Çπ${monthly.income.toFixed(2)}` : '‚Äî';
      const sumNetEl = document.getElementById('sum-net'); if(sumNetEl) sumNetEl.textContent = monthly ? `‚Çπ${monthly.net.toFixed(2)}` : '‚Äî';

      // Category breakdown: prefer data.categories else empty
      const categories = (data && data.categories && data.categories.length) ? data.categories : [];
      const maxCat = categories.length > 0 ? Math.max(...categories.map(c=>c[1])) : 1;
      const catList = document.getElementById('category-list');
      if(catList){
        catList.innerHTML = '';
        if(categories.length > 0){
          categories.forEach(c=>{
            const pct = Math.round((c[1]/maxCat)*100);
            const div = document.createElement('div');
            div.innerHTML = `<div class="flex items-center justify-between"><div>${c[0]}</div><div class="font-semibold">‚Çπ${c[1]}</div></div><div class="w-full h-2 bg-gray-200 rounded mt-1"><div style='width:${pct}% ' class='h-2 bg-indigo-500 rounded'></div></div>`;
            catList.appendChild(div);
          });
        }
      }
      const catSpark = document.getElementById('cat-spark');
      if(catSpark){
        if(categories.length > 0){
          const pts = categories.map((c,i)=> `${10 + i*20},${30 - (c[1]/maxCat)*24}`).join(' ');
          catSpark.innerHTML = `<polyline points="${pts}" fill="none" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
        }
      }

      // Recent txns: prefer recentTxns or empty
      const txsData = (recentTxns && recentTxns.transactions) ? recentTxns.transactions : [];
      const txs = document.getElementById('recent-txns');
      txs.innerHTML = '';
      txsData.forEach(t=>{
        const tr = document.createElement('tr');
        // t may be array (mock) or object
        if(Array.isArray(t)){
          tr.innerHTML = `<td class='py-2 ${t[0]==='Income'?'text-green-600':'text-red-600'}'>${t[0]}</td><td class='py-2'>${t[1]}</td><td class='py-2 font-semibold'>‚Çπ${t[2]}</td><td class='py-2 muted'>${t[3]}</td>`;
        } else {
          // Format date properly
          let dateStr = t.occurred_at || t.date || '';
          if(dateStr && dateStr.includes('T')) {
            const dt = new Date(dateStr);
            dateStr = dt.toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'});
          }
          tr.innerHTML = `<td class='py-2 ${t.txn_type==='income'?'text-green-600':'text-red-600'}'>${t.txn_type}</td><td class='py-2'>${t.category || t.category_name || ''}</td><td class='py-2 font-semibold'>‚Çπ${((t.amount_cents||0)/100).toFixed(2)}</td><td class='py-2 muted'>${dateStr}</td>`;
        }
        txs.appendChild(tr);
      });

      // Stagnant right column values (Quick Overview)
      const stIncomeEl = document.getElementById('st-income'); if(stIncomeEl) stIncomeEl.textContent = monthly ? `‚Çπ${monthly.income.toFixed(2)}` : '‚Äî';
      const stExpenseEl = document.getElementById('st-expense'); if(stExpenseEl) stExpenseEl.textContent = monthly ? `‚Çπ${monthly.expense.toFixed(2)}` : '‚Äî';
      const stBillsEl = document.getElementById('st-bills'); if(stBillsEl) stBillsEl.textContent = `${(reminders.due_today||[]).length + (reminders.upcoming||[]).length} upcoming`;
      const stTxnsEl = document.getElementById('st-txns'); if(stTxnsEl) stTxnsEl.textContent = `${txsData.length} recent`;

      // Quick metrics fields (removed from layout ‚Äî update only if present)
      const qmBillsEl = document.getElementById('qm-bills'); if(qmBillsEl) qmBillsEl.textContent = `${(reminders.upcoming||[]).length}`;
      const qmTxnsEl = document.getElementById('qm-txns'); if(qmTxnsEl) qmTxnsEl.textContent = `${txsData.length}`;

      // budget utilization (mock calculation if server not provided) ‚Äî guard elements
      const essentialsPct = data.utilization ? data.utilization.essentials_pct : 40;
      const discrPct = data.utilization ? data.utilization.discretionary_pct : 30;
      const utilEss = document.getElementById('util-essentials'); if(utilEss) utilEss.style.width = essentialsPct + '%';
      const utilDis = document.getElementById('util-discr'); if(utilDis) utilDis.style.width = discrPct + '%';

      // trendline - use real data if available, otherwise fallback to mock data
      const trend = (data && data.trend && data.trend.points) ? data.trend.points : [10,12,14,13,15,18,16,19,20,18];
      const maxT = Math.max(...trend, 1);  // Prevent division by zero
      const points = trend.map((v,i)=> `${i*(100/(trend.length-1))},${36 - (v/maxT)*32}`).join(' ');
      document.getElementById('trendline').setAttribute('points', points);
    }

    loadDashboard();

    // Register page load hook for SPA navigation
    window.onPageLoad = loadDashboard;

    // Run reminder button wired to backend when available
    const runRemBtn = document.getElementById('run-reminder');
    if(runRemBtn){
      runRemBtn.addEventListener('click', async function(){
        try{
          const r = await fetch('/api/agents/reminders/run', {method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
          const j = await r.json().catch(()=>({}));
          // reload reminders after run
          await loadDashboard();
          alert('Reminder agent run: ' + (j.status||'done'));
        }catch(e){
          alert('Failed to run reminder agent: ' + e);
        }
      });
    }

    // Run Insights button handler
    const runInsightsBtn = document.getElementById('run-insights');
    if(runInsightsBtn){
      runInsightsBtn.addEventListener('click', async function(){
        runInsightsBtn.disabled = true;
        runInsightsBtn.textContent = 'Analyzing...';
        const container = document.getElementById('insights-container');
        
        try{
          const r = await fetch('/api/agents/insights/run', {method:'POST', credentials:'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({})});
          const j = await r.json().catch(() => ({error: 'invalid json'}));
          
          if(j.result && !j.result.error) {
            renderInsights(j.result, container);
            // Cache the insights result
            localStorage.setItem('finassist_insights_cache', JSON.stringify(j.result));
          } else {
            container.innerHTML = `<div class="text-red-600 text-sm p-4 bg-red-50 rounded border border-red-200">Error: ${j.result?.error || j.error || 'Unknown error'}</div>`;
          }
        } catch(e){
          container.innerHTML = `<div class="text-red-600 text-sm p-4 bg-red-50 rounded border border-red-200">Failed: ${e.message}</div>`;
        } finally {
          runInsightsBtn.disabled = false;
          runInsightsBtn.textContent = 'Analyze Now';
        }
      });
    }
    
    // Auto-load insights on page load
    async function autoLoadInsights() {
      const insightsContainer = document.getElementById('insights-container');
      if(!insightsContainer) return;
      
      // Try cached first
      const cachedInsights = localStorage.getItem('finassist_insights_cache');
      if(cachedInsights) {
        try {
          const cached = JSON.parse(cachedInsights);
          if(cached && !cached.error) {
            renderInsights(cached, insightsContainer);
            return;
          }
        } catch(e) {
          // Invalid cached data, proceed to fetch fresh
        }
      }
      
      // No cache, fetch fresh insights
      insightsContainer.innerHTML = '<div class="text-sm text-gray-500">Analyzing your spending...</div>';
      try {
        const r = await fetch('/api/agents/insights/run', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const j = await r.json().catch(() => ({error: 'invalid json'}));
        
        if(j.result && !j.result.error) {
          renderInsights(j.result, insightsContainer);
          localStorage.setItem('finassist_insights_cache', JSON.stringify(j.result));
        } else {
          insightsContainer.innerHTML = `<div class="text-gray-500 text-sm">Could not generate insights. Try again.</div>`;
        }
      } catch(e) {
        insightsContainer.innerHTML = `<div class="text-gray-500 text-sm">Unable to load insights</div>`;
      }
    }
    
    autoLoadInsights();
    
    // Render insights in a nice format
    function renderInsights(data, container) {
      if(!data) {
        container.innerHTML = '<div class="text-gray-500 text-sm">No insights available</div>';
        return;
      }
      
      let html = '';
      
      // Top spending category
      if(data.top_spending_category) {
        html += `<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
          <div class="flex justify-between items-start mb-2">
            <div><div class="text-xs uppercase tracking-wide text-gray-600 font-medium">Top Spending</div>
            <div class="text-2xl font-bold text-green-700">‚Çπ${(data.top_spending_amount_rupees || 0).toLocaleString('en-IN')}</div></div>
            <div class="text-right text-sm font-medium text-gray-700">${data.top_spending_category}</div>
          </div>
        </div>`;
      }
      
      // Behavior pattern
      if(data.behavior_pattern) {
        html += `<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-2">Spending Behavior</div>
          <div class="text-sm text-gray-800 leading-relaxed">${data.behavior_pattern}</div>
        </div>`;
      }
      
      // Week over week change
      if(data.week_over_week_change_percent) {
        const isIncrease = data.week_over_week_change_percent.includes('+');
        const color = isIncrease ? 'red' : 'green';
        html += `<div class="p-4 bg-${color}-50 border-l-4 border-${color}-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium">Week vs Week</div>
          <div class="text-2xl font-bold text-${color}-700">${data.week_over_week_change_percent}</div>
        </div>`;
      }
      
      // Top 3 categories
      if(data.top_3_categories && Array.isArray(data.top_3_categories)) {
        html += `<div class="p-4 bg-purple-50 border-l-4 border-purple-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-3">Top Categories</div>
          <div class="space-y-2">
            ${data.top_3_categories.map(cat => `
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-700">${cat.category}</span>
                <div class="text-right">
                  <div class="font-semibold text-gray-900">‚Çπ${(cat.amount_rupees || 0).toLocaleString('en-IN')}</div>
                  <div class="text-xs text-gray-500">${cat.percentage_of_total || 'N/A'}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
      
      // Key observation
      if(data.key_observation) {
        html += `<div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
          <div class="text-sm font-medium text-yellow-900">üéØ Key Insight: ${data.key_observation}</div>
        </div>`;
      }
      
      // Recommendation
      if(data.recommendation) {
        html += `<div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-2">üí° Recommendation</div>
          <div class="text-sm text-gray-800">${data.recommendation}</div>
        </div>`;
      }
      
      container.innerHTML = html || '<div class="text-gray-500 text-sm">No detailed insights</div>';
    }

    // Run Forecast button handler
    const runForecastBtn = document.getElementById('run-forecast');
    if(runForecastBtn){
      runForecastBtn.addEventListener('click', async function(){
        runForecastBtn.disabled = true;
        runForecastBtn.textContent = 'Forecasting...';
        const container = document.getElementById('forecast-container');
        
        try{
          const r = await fetch('/api/agents/forecast/run', {method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
          const j = await r.json().catch(() => ({error: 'invalid json'}));
          
          if(j.result && !j.result.error) {
            renderForecast(j.result, container);
            // Cache the forecast result
            localStorage.setItem('finassist_forecast_cache', JSON.stringify(j.result));
          } else {
            container.innerHTML = `<div class="text-red-600 text-sm p-4 bg-red-50 rounded border border-red-200">Error: ${j.result?.error || j.error || 'Unknown error'}</div>`;
          }
        } catch(e){
          container.innerHTML = `<div class="text-red-600 text-sm p-4 bg-red-50 rounded border border-red-200">Failed: ${e.message}</div>`;
        } finally {
          runForecastBtn.disabled = false;
          runForecastBtn.textContent = 'Forecast Now';
        }
      });
    }
    
    // Load cached forecast on page load
    async function autoLoadForecast() {
      const forecastContainer = document.getElementById('forecast-container');
      if(!forecastContainer) return;
      
      // Try cached first
      const cachedForecast = localStorage.getItem('finassist_forecast_cache');
      if(cachedForecast) {
        try {
          const cached = JSON.parse(cachedForecast);
          if(cached && !cached.error) {
            renderForecast(cached, forecastContainer);
            return;
          }
        } catch(e) {
          // Invalid cached data, proceed to fetch fresh
        }
      }
      
      // No cache, fetch fresh forecast
      forecastContainer.innerHTML = '<div class="text-sm text-gray-500">Generating forecast...</div>';
      try {
        const r = await fetch('/api/agents/forecast/run', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const j = await r.json().catch(() => ({error: 'invalid json'}));
        
        if(j.result && !j.result.error) {
          renderForecast(j.result, forecastContainer);
          localStorage.setItem('finassist_forecast_cache', JSON.stringify(j.result));
        } else {
          forecastContainer.innerHTML = `<div class="text-gray-500 text-sm">Could not generate forecast. Try again.</div>`;
        }
      } catch(e) {
        forecastContainer.innerHTML = `<div class="text-gray-500 text-sm">Unable to load forecast</div>`;
      }
    }
    
    autoLoadForecast();
    
    // Render forecast in a nice format
    function renderForecast(data, container) {
      if(!data) {
        container.innerHTML = '<div class="text-gray-500 text-sm">No forecast available</div>';
        return;
      }
      
      let html = '';
      
      // Key metrics
      const expenseRupees = data.predicted_expense_rupees || (data.predicted_expense_cents ? data.predicted_expense_cents / 100 : 0);
      const incomeRupees = data.predicted_income_rupees || (data.predicted_income_cents ? data.predicted_income_cents / 100 : 0);
      const netRupees = data.expected_net_rupees || (data.expected_net_cents ? data.expected_net_cents / 100 : 0);
      
      html += `<div class="grid grid-cols-3 gap-3 mb-4">
        <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-1">Predicted Expense</div>
          <div class="text-2xl font-bold text-red-600">‚Çπ${expenseRupees.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
        <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-1">Predicted Income</div>
          <div class="text-2xl font-bold text-green-600">‚Çπ${incomeRupees.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
        <div class="p-4 ${netRupees >= 0 ? 'bg-blue-50 border-blue-500' : 'bg-orange-50 border-orange-500'} border-l-4 rounded">
          <div class="text-xs uppercase tracking-wide text-gray-600 font-medium mb-1">Expected Net</div>
          <div class="text-2xl font-bold ${netRupees >= 0 ? 'text-blue-600' : 'text-orange-600'}">‚Çπ${netRupees.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
        </div>
      </div>`;
      
      // Confidence
      if(data.confidence) {
        const colorMap = {'HIGH': 'green', 'MEDIUM': 'yellow', 'LOW': 'red'};
        const color = colorMap[data.confidence] || 'gray';
        html += `<div class="p-3 bg-${color}-50 border-l-4 border-${color}-500 rounded text-sm">
          <span class="font-medium text-${color}-900">Confidence: ${data.confidence}</span>
        </div>`;
      }
      
      // Forecast explanation
      if(data.forecast_explanation) {
        html += `<div class="p-4 bg-gray-50 border rounded">
          <div class="text-sm font-medium text-gray-900 mb-2">üìä Analysis</div>
          <div class="text-sm text-gray-700 leading-relaxed">${data.forecast_explanation}</div>
        </div>`;
      }
      
      // Biggest risk
      if(data.biggest_risk) {
        html += `<div class="p-4 bg-orange-50 border-l-4 border-orange-500 rounded">
          <div class="text-sm font-medium text-orange-900">‚ö†Ô∏è Biggest Risk</div>
          <div class="text-sm text-orange-800 mt-1">${data.biggest_risk}</div>
        </div>`;
      }
      
      // Savings opportunity
      if(data.savings_opportunity) {
        html += `<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded">
          <div class="text-sm font-medium text-green-900">üí∞ Savings Opportunity</div>
          <div class="text-sm text-green-800 mt-1">${data.savings_opportunity}</div>
        </div>`;
      }
      
      container.innerHTML = html || '<div class="text-gray-500 text-sm">No detailed forecast</div>';
    }


    // Debug panel: toggle and fetch raw API JSON to help diagnose missing values
    const toggleDebugBtn = document.getElementById('toggle-debug');
    const debugPanel = document.getElementById('debug-panel');
    if(toggleDebugBtn && debugPanel){
      toggleDebugBtn.addEventListener('click', async function(){
        if(debugPanel.style.display === 'none'){
          debugPanel.textContent = 'Loading API responses...';
          try{
            // first, check authentication/debug info
            let whoami = null;
            try{
              whoami = await fetchJson('/_debug/whoami');
            }catch(e){ whoami = { error: String(e) }; }

            const endpoints = ['/api/dashboard/summary','/api/transactions/recent','/api/notifications/json'];
            const results = {};
            for(const ep of endpoints){
              try{
                const r = await fetch(ep, { credentials: 'same-origin' });
                if(!r.ok){
                  results[ep] = { ok:false, status: r.status, statusText: r.statusText };
                  try{ results[ep].body = await r.text(); }catch(e){}
                } else {
                  try{
                    const body = await r.json();
                    results[ep] = { ok:true, status: r.status, body };
                  }catch(e){
                    results[ep] = { ok:true, status: r.status, body_text: await r.text() };
                  }
                }
              }catch(err){
                results[ep] = { ok:false, error: String(err) };
              }
            }

            const out = { whoami, results };
            debugPanel.textContent = JSON.stringify(out, null, 2);
          }catch(e){
            debugPanel.textContent = 'Debug fetch failed: ' + String(e);
          }
          debugPanel.style.display = 'block';
          toggleDebugBtn.textContent = 'Hide API';
        } else {
          debugPanel.style.display = 'none';
          toggleDebugBtn.textContent = 'Show API';
        }
      });
    }

  </script>
</body>
</html>