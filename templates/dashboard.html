<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard â€¢ FinAssist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
  <style>
    /* small tweaks for sticky right column and card shadows */
    body { overflow-x: hidden; }
    /* dashboard container fits window minus left sidebar (18rem) to prevent horizontal scroll */
    .dashboard-container { width: calc(100vw - 18rem); max-width: calc(100vw - 18rem); box-sizing: border-box; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(15,23,42,0.06); display: flex; flex-direction: column; }
    .muted { color: #6b7280 }
    .sparkline { width: 100%; height: 36px; }
    .scroll-area { max-height: calc(100vh - 140px); overflow: auto; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  {% include 'sidebar.html' %}

  <header class="fixed top-0 left-72 right-0 bg-white border-b z-20">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-500">Welcome, <span class="font-semibold">{{ session.get('user_email') or 'Friend' }}</span></div>
        <div class="flex items-center gap-2">
          <div class="text-xs text-gray-400" id="dashboard-date"></div>
          <button id="dashboard-refresh" title="Refresh dashboard" class="text-xs px-2 py-1 bg-gray-100 rounded">Refresh</button>
        </div>
      </div>
      <div class="text-right">
        <div class="text-base font-semibold">Dashboard</div>
        <div class="text-sm muted">Your AI-powered financial overview is ready.</div>
      </div>
    </div>
  </header>

  <main class="ml-72 pt-20">
    <div class="dashboard-container mx-auto grid grid-cols-12 gap-6 px-4">
      <!-- Left / Main Scrollable Column -->
      <section class="col-span-9">
        <div class="space-y-6 scroll-area pr-4">

          <!-- AI Insights -->
          <div class="card p-5 h-full flex flex-col min-h-72">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">ðŸ§  AI Insights</h2>
              <div class="flex items-center gap-3">
                <div class="text-sm muted" id="insights-source">Source: insight_agent_v1</div>
                <button id="run-insights" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Run Insights</button>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-4 gap-4">
              <div class="col-span-2">
                <div class="text-sm muted">Biggest expense</div>
                <div id="insight-top-category" class="text-xl font-bold mt-1">â€”</div>
              </div>
              <div>
                <div class="text-sm muted">Week-over-week</div>
                <div id="insight-wow" class="text-lg font-semibold mt-1">â€”</div>
              </div>
              <div>
                <div class="text-sm muted">Lowest expense</div>
                <div id="insight-biggest" class="text-lg font-semibold mt-1">â€”</div>
              </div>
            </div>
            <div class="mt-4 flex items-start gap-6">
              <div class="flex-1">
                <div class="text-sm muted">Behavior pattern</div>
                <div id="insight-pattern" class="mt-1">â€”</div>
              </div>
              <div class="w-64">
                <div class="text-sm muted">Smart recommendation</div>
                <div id="insight-reco" class="text-sm bg-green-50 border-l-4 border-green-400 p-3 mt-1 rounded">â€”</div>
              </div>
            </div>
          </div>

          <!-- Forecast -->
          <div class="card p-5 h-full flex flex-col min-h-72">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">ðŸ“ˆ AI Forecast (Next Month)</h2>
              <div class="flex items-center gap-3">
                <div class="text-sm muted" id="forecast-source">Source: forecast_agent_v1</div>
                <button id="run-forecast" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Run Forecast</button>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-4">
              <div>
                <div class="text-sm muted">Predicted total</div>
                <div id="forecast-total" class="text-2xl font-bold mt-1">â€”</div>
              </div>
              <div>
                <div class="text-sm muted">Category shifts</div>
                <div id="forecast-cats" class="mt-1 text-sm">â€”</div>
              </div>
              <div>
                <div class="text-sm muted">Estimated savings</div>
                <div id="forecast-savings" class="text-lg font-semibold mt-1">â€”</div>
              </div>
            </div>
            <div class="mt-4">
              <div class="text-sm muted">Trend summary</div>
              <div id="forecast-trend" class="mt-2 text-sm">â€”</div>
            </div>
          </div>

          <!-- Reminders -->
          <div class="card p-5 h-full flex flex-col">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">ðŸ”” Bill Reminders</h2>
              <div class="text-sm muted">Source: reminder_agent_v1 & notifications</div>
            </div>
            <div class="mt-3" id="reminder-ai-block">â€”</div>
            <div class="mt-4 grid grid-cols-3 gap-4">
              <div>
                <div class="text-sm font-semibold text-orange-600">Due Today</div>
                <div id="reminders-due-today" class="mt-2 space-y-2"></div>
              </div>
              <div>
                <div class="text-sm font-semibold text-yellow-600">Upcoming</div>
                <div id="reminders-upcoming" class="mt-2 space-y-2"></div>
              </div>
              <div>
                <div class="text-sm font-semibold text-red-600">Overdue</div>
                <div id="reminders-overdue" class="mt-2 space-y-2"></div>
              </div>
            </div>
          </div>

          <!-- Monthly Summary (single card) -->
          <div class="card p-5 h-full flex flex-col">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">ðŸ’¸ Monthly Summary</h2>
              <div class="text-sm muted">Transactions summary</div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-4">
              <div class="p-4 rounded border">
                <div class="text-sm muted">Total Expense</div>
                <div id="sum-expense" class="text-2xl font-bold text-red-600 mt-2">â€”</div>
              </div>
              <div class="p-4 rounded border">
                <div class="text-sm muted">Total Income</div>
                <div id="sum-income" class="text-2xl font-bold text-green-600 mt-2">â€”</div>
              </div>
              <div class="p-4 rounded border">
                <div class="text-sm muted">Net Savings</div>
                <div id="sum-net" class="text-2xl font-bold text-blue-600 mt-2">â€”</div>
              </div>
            </div>
          </div>

          <!-- Category Breakdown and Quick Metrics removed -->
    

          <!-- Recent Transactions -->
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">ðŸ§¾ Recent Transactions</h2>
              <div class="text-sm muted">Last 5 transactions</div>
            </div>
            <div class="mt-4">
              <table class="w-full text-left text-sm">
                <thead class="text-xs text-gray-500">
                  <tr>
                    <th class="pb-2">Type</th>
                    <th class="pb-2">Category</th>
                    <th class="pb-2">Amount</th>
                    <th class="pb-2">Date</th>
                  </tr>
                </thead>
                <tbody id="recent-txns" class="text-sm"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- Right sticky results column -->
      <aside class="col-span-3">
        <div class="sticky top-20 space-y-4">
          <div class="card p-4 min-h-56">
            <div class="flex items-center justify-between">
              <div class="text-sm muted">Stagnant Results</div>
              <div class="text-xs muted">Quick summary</div>
            </div>
            <div class="mt-3 space-y-4">
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs muted">Income (this month)</div>
                <div id="st-income" class="text-lg font-semibold text-green-600">â€”</div>
              </div>
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs muted">Expenses (this month)</div>
                <div id="st-expense" class="text-lg font-semibold text-red-600">â€”</div>
              </div>
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs muted">Upcoming bills</div>
                <div id="st-bills" class="text-lg font-semibold">â€”</div>
              </div>
              <div class="p-3 bg-gray-50 rounded">
                <div class="text-xs muted">Recent transactions</div>
                <div id="st-txns" class="text-lg font-semibold">â€”</div>
              </div>
            </div>
          </div>

          <div class="card p-4 min-h-48">
            <div class="text-sm muted">Spending Trend</div>
            <svg class="sparkline mt-3" viewBox="0 0 100 36" preserveAspectRatio="none"><polyline id="trendline" fill="none" stroke="#0ea5a4" stroke-width="2" points=""></polyline></svg>
          </div>

          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm muted">Debug</div>
              <button id="toggle-debug" class="text-xs px-2 py-1 bg-gray-100 rounded">Show API</button>
            </div>
            <pre id="debug-panel" class="mt-3 text-xs overflow-auto" style="max-height:200px;display:none;background:#111827;color:#d1d5db;padding:8px;border-radius:6px;"></pre>
          </div>
        
        </div>
      </aside>

    </div>
  </main>

  <script>
    // No local mock data: dashboard now prefers live DB-driven endpoints.
    // The client will show empty/placeholder values if endpoints are not available.

    // hydrate UI: try to fetch DB-driven endpoints; fall back to mock data when unavailable
    async function fetchJson(url){
      try{
        const r = await fetch(url, {credentials: 'same-origin'});
        if(r.ok) return await r.json();
      }catch(e){/* ignore */}
      return null;
    }

    async function loadDashboard(){
      // server endpoints we will try to use (these may be added later):
      // /api/dashboard/summary => { monthly:{income,expense,net}, categories:[...], reminders:{...} }
      // /api/transactions/recent => [{type,category,amount,date}, ...]
      // /api/notifications/json => { notifications: [...] }
      const [summary, recentTxns, notifications] = await Promise.all([
        fetchJson('/api/dashboard/summary'),
        fetchJson('/api/transactions/recent'),
        fetchJson('/api/notifications/json')
      ]);

      const data = summary || {};

      const source = summary ? 'live' : 'mock';

      // Insights & Forecast remain mocked (AI agents). Fill those from mock always.
        // Insights & Forecast: prefer live agent results, fall back to mock
        // dashboard time UI: show nice formatted time + "Updated X ago"
        let _lastFetchTime = null;
        function _formatDateTime(d){
          try{
            return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + ' â€¢ ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
          }catch(e){
            return d.toString();
          }
        }
        function _timeAgo(d){
          if(!d) return '';
          const s = Math.floor((Date.now() - d.getTime())/1000);
          if(s < 5) return 'just now';
          if(s < 60) return s + 's ago';
          const m = Math.floor(s/60);
          if(m < 60) return m + 'm ago';
          const h = Math.floor(m/60);
          if(h < 24) return h + 'h ago';
          const days = Math.floor(h/24);
          if(days === 1) return 'yesterday';
          return days + 'd ago';
        }

        function updateDashboardDateDisplay(){
          const el = document.getElementById('dashboard-date');
          if(!el) return;
          const now = new Date();
          const ref = _lastFetchTime || now;
          const main = _formatDateTime(ref);
          const rel = _timeAgo(ref);
          el.innerHTML = `<div class="font-medium">${main}</div><div class="text-xs muted">Updated ${rel}</div>`;
        }

        // refresh button handler
        const _refreshBtn = document.getElementById('dashboard-refresh');
        if(_refreshBtn){
          _refreshBtn.addEventListener('click', async function(){
            _refreshBtn.disabled = true;
            _refreshBtn.textContent = 'Refreshingâ€¦';
            try{ await loadDashboard(); }catch(e){}
            _refreshBtn.disabled = false;
            _refreshBtn.textContent = 'Refresh';
          });
        }

        // update the displayed relative time every 10 seconds
        setInterval(updateDashboardDateDisplay, 10000);
        let insightsRes = await fetchJson('/api/agents/insights');
        // If no cached insights exist yet, trigger a cached refresh (no AI) and re-fetch so dashboard shows DB-driven insights.
        if(!insightsRes){
          try{
            await fetch('/api/agents/insights/run', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
            insightsRes = await fetchJson('/api/agents/insights');
          }catch(e){ /* ignore */ }
        }
        let forecastRes = await fetchJson('/api/agents/forecast');
        if(!forecastRes){
          try{
            await fetch('/api/agents/forecast/run', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
            forecastRes = await fetchJson('/api/agents/forecast');
          }catch(e){ /* ignore */ }
        }

        // Insights
        const insElTop = document.getElementById('insight-top-category');
        const insElWow = document.getElementById('insight-wow');
        const insElBig = document.getElementById('insight-biggest');
        const insElPattern = document.getElementById('insight-pattern');
        const insElReco = document.getElementById('insight-reco');

        if(insightsRes && insightsRes.result){
          const ins = insightsRes.result;
          // Biggest expense (deterministic or AI-provided)
          const big = ins.biggest_expense || ins.biggest || null;
          if(insElTop){
            if(big){
              const bam = (big.amount_cents || big.amountCents || big.amount || 0)/100;
              const bl = big.label || big.name || '';
              insElTop.textContent = `â‚¹${bam.toFixed(2)} â€¢ ${bl}`;
            } else if(ins.raw) {
              insElTop.textContent = ins.raw.slice(0,80) + '...';
            } else {
              insElTop.textContent = 'â€”';
            }
          }
          if(insElWow){
            const wow = ins.week_over_week_change || ins.week_over_week || ins.wow || null;
            if(wow) insElWow.textContent = wow;
          }
          // Lowest expense (new)
          if(insElBig){
            const low = ins.lowest_expense || ins.lowest || null;
            if(low){
              const lam = (low.amount_cents || low.amountCents || low.amount || 0)/100;
              const ll = low.label || low.name || '';
              insElBig.textContent = `â‚¹${lam.toFixed(2)} â€¢ ${ll}`;
            } else {
              insElBig.textContent = 'â€”';
            }
          }
          if(insElPattern){ if(ins.behavior_pattern) insElPattern.textContent = ins.behavior_pattern; else if(ins.pattern) insElPattern.textContent = ins.pattern; }
          if(insElReco){ if(ins.recommendation) insElReco.textContent = ins.recommendation; else if(ins.reco) insElReco.textContent = ins.reco; }
        } else {
          // No live insights available â€” show neutral placeholders
          if(insElTop) insElTop.textContent = 'No data';
          if(insElWow) insElWow.textContent = 'â€”';
          if(insElBig) insElBig.textContent = 'â€”';
          if(insElPattern) insElPattern.textContent = 'â€”';
          if(insElReco) insElReco.textContent = 'â€”';
        }

        // Forecast
        const fTotalEl = document.getElementById('forecast-total');
        const fCatsEl = document.getElementById('forecast-cats');
        const fSavingsEl = document.getElementById('forecast-savings');
        const fTrendEl = document.getElementById('forecast-trend');

        if(forecastRes && forecastRes.result){
          const f = forecastRes.result;
          const expC = f.predicted_total_expense_cents || f.predictedTotalExpenseCents || f.predicted_expense_cents || 0;
          const incC = f.predicted_total_income_cents || f.predictedTotalIncomeCents || f.predicted_income_cents || 0;
          if(fTotalEl) fTotalEl.textContent = `Expense: â‚¹${(expC/100).toFixed(2)}`;
          if(fCatsEl) fCatsEl.textContent = '';
          if(fSavingsEl) fSavingsEl.textContent = `Income: â‚¹${(incC/100).toFixed(2)}`;
          if(fTrendEl && (f.narrative || f.story)) fTrendEl.textContent = f.narrative || f.story;
        } else {
          if(fTotalEl) fTotalEl.textContent = 'â€”';
          if(fCatsEl) fCatsEl.textContent = 'â€”';
          if(fSavingsEl) fSavingsEl.textContent = 'â€”';
          if(fTrendEl) fTrendEl.textContent = 'â€”';
        }

      // Reminders: prefer notifications endpoint; default to empty lists
      let reminders = { ai_text: null, due_today: [], upcoming: [], overdue: [] };
      if(notifications && Array.isArray(notifications.notifications)){
        // transform provider notifications to our simple structure (amount in rupees as number)
        const ns = notifications.notifications;
        const due_today = ns.filter(n=> n.type && n.type.includes('today')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)}));
        const upcoming = ns.filter(n=> n.type && n.type.includes('week')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)}));
        reminders = { ai_text: null, due_today, upcoming, overdue: ns.filter(n=> n.type && n.type.includes('overdue')).map(n=>({name:n.title, due:(n.meta && n.meta.due_date)||n.created_at, amount:(n.meta && n.meta.amount_cents ? (n.meta.amount_cents||0)/100.0 : 0)})) };
      }
      document.getElementById('reminder-ai-block').innerHTML = reminders.ai_text ? `<div class="text-sm bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">${reminders.ai_text}</div>` : '';
      function mkBillCard(b){ return `<div class="p-3 rounded border flex items-center justify-between"><div><div class="font-semibold">${b.name}</div><div class="text-xs muted">Due ${b.due}</div></div><div class="text-sm font-semibold">â‚¹${(b.amount||0).toFixed(2)}</div></div>` }
      document.getElementById('reminders-due-today').innerHTML = (reminders.due_today||[]).map(mkBillCard).join('');
      document.getElementById('reminders-upcoming').innerHTML = (reminders.upcoming||[]).map(mkBillCard).join('');
      document.getElementById('reminders-overdue').innerHTML = (reminders.overdue||[]).map(mkBillCard).join('');

      // record last successful refresh time and update header display
      try{ _lastFetchTime = new Date(); }catch(e){}
      try{ updateDashboardDateDisplay(); }catch(e){}

      // Monthly summary: prefer summary.monthly
      const monthly = (data && data.monthly) ? data.monthly : null;
      const sumExpenseEl = document.getElementById('sum-expense'); if(sumExpenseEl) sumExpenseEl.textContent = monthly ? `â‚¹${monthly.expense.toFixed(2)}` : 'â€”';
      const sumIncomeEl = document.getElementById('sum-income'); if(sumIncomeEl) sumIncomeEl.textContent = monthly ? `â‚¹${monthly.income.toFixed(2)}` : 'â€”';
      const sumNetEl = document.getElementById('sum-net'); if(sumNetEl) sumNetEl.textContent = monthly ? `â‚¹${(monthly.income - monthly.expense).toFixed(2)}` : 'â€”';

      // Category breakdown: prefer data.categories else empty
      const categories = (data && data.categories && data.categories.length) ? data.categories : [];
      const maxCat = Math.max(...categories.map(c=>c[1]));
      const catList = document.getElementById('category-list');
      if(catList){
        catList.innerHTML = '';
        categories.forEach(c=>{
          const pct = Math.round((c[1]/maxCat)*100);
          const div = document.createElement('div');
          div.innerHTML = `<div class="flex items-center justify-between"><div>${c[0]}</div><div class="font-semibold">â‚¹${c[1]}</div></div><div class="w-full h-2 bg-gray-200 rounded mt-1"><div style='width:${pct}% ' class='h-2 bg-indigo-500 rounded'></div></div>`;
          catList.appendChild(div);
        });
      }
      const catSpark = document.getElementById('cat-spark');
      if(catSpark){
        const pts = categories.map((c,i)=> `${10 + i*20},${30 - (c[1]/maxCat)*24}`).join(' ');
        catSpark.innerHTML = `<polyline points="${pts}" fill="none" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
      }

      // Recent txns: prefer recentTxns or empty
      const txsData = (recentTxns && recentTxns.transactions) ? recentTxns.transactions : [];
      const txs = document.getElementById('recent-txns');
      txs.innerHTML = '';
      txsData.forEach(t=>{
        const tr = document.createElement('tr');
        // t may be array (mock) or object
        if(Array.isArray(t)){
          tr.innerHTML = `<td class='py-2 ${t[0]==='Income'?'text-green-600':'text-red-600'}'>${t[0]}</td><td class='py-2'>${t[1]}</td><td class='py-2 font-semibold'>â‚¹${t[2]}</td><td class='py-2 muted'>${t[3]}</td>`;
        } else {
          tr.innerHTML = `<td class='py-2 ${t.txn_type==='income'?'text-green-600':'text-red-600'}'>${t.txn_type}</td><td class='py-2'>${t.category || t.category_name || ''}</td><td class='py-2 font-semibold'>â‚¹${((t.amount_cents||0)/100).toFixed(2)}</td><td class='py-2 muted'>${t.occurred_at || t.date || ''}</td>`;
        }
        txs.appendChild(tr);
      });

      // Stagnant right column values
      const stIncomeEl = document.getElementById('st-income'); if(stIncomeEl) stIncomeEl.textContent = monthly ? `â‚¹${monthly.income.toFixed(2)}` : 'â€”';
      const stExpenseEl = document.getElementById('st-expense'); if(stExpenseEl) stExpenseEl.textContent = monthly ? `â‚¹${monthly.expense.toFixed(2)}` : 'â€”';
      const stBillsEl = document.getElementById('st-bills'); if(stBillsEl) stBillsEl.textContent = `${(reminders.due_today||[]).length + (reminders.upcoming||[]).length} upcoming`;
      const stTxnsEl = document.getElementById('st-txns'); if(stTxnsEl) stTxnsEl.textContent = `${txsData.length} recent`;

      // Quick metrics fields (removed from layout â€” update only if present)
      const qmBillsEl = document.getElementById('qm-bills'); if(qmBillsEl) qmBillsEl.textContent = `${(reminders.upcoming||[]).length}`;
      const qmTxnsEl = document.getElementById('qm-txns'); if(qmTxnsEl) qmTxnsEl.textContent = `${txsData.length}`;

      // budget utilization (mock calculation if server not provided) â€” guard elements
      const essentialsPct = data.utilization ? data.utilization.essentials_pct : 40;
      const discrPct = data.utilization ? data.utilization.discretionary_pct : 30;
      const utilEss = document.getElementById('util-essentials'); if(utilEss) utilEss.style.width = essentialsPct + '%';
      const utilDis = document.getElementById('util-discr'); if(utilDis) utilDis.style.width = discrPct + '%';

      // trendline (mocked if no data)
      const trend = (data.trend && data.trend.points) ? data.trend.points : [10,12,14,13,15,18,16,19,20,18];
      const maxT = Math.max(...trend);
      const points = trend.map((v,i)=> `${i*(100/(trend.length-1))},${36 - (v/maxT)*32}`).join(' ');
      document.getElementById('trendline').setAttribute('points', points);
    }

    loadDashboard();

    // Run reminder button wired to backend when available
    const runRemBtn = document.getElementById('run-reminder');
    if(runRemBtn){
      runRemBtn.addEventListener('click', async function(){
        try{
          const r = await fetch('/api/agents/reminders/run', {method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
          const j = await r.json().catch(()=>({}));
          // reload reminders after run
          await loadDashboard();
          alert('Reminder agent run: ' + (j.status||'done'));
        }catch(e){
          alert('Failed to run reminder agent: ' + e);
        }
      });
    }

    // Run Insights button handler
    const runInsightsBtn = document.getElementById('run-insights');
    if(runInsightsBtn){
      runInsightsBtn.addEventListener('click', async function(){
        if(!confirm('Run Insights now? This may call the AI and use quota. Click OK to force AI, Cancel to refresh cached insights.')){
          // user cancelled force; do a cached refresh
          runInsightsBtn.disabled = true;
          runInsightsBtn.textContent = 'Refreshingâ€¦';
          try{
            const r = await fetch('/api/agents/insights/run', {method:'POST', credentials:'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({})});
            await loadDashboard();
            alert('Insights refreshed (cached)');
          }catch(e){
            alert('Failed to refresh insights: ' + e);
          } finally {
            runInsightsBtn.disabled = false;
            runInsightsBtn.textContent = 'Run Insights';
          }
          return;
        }

        // confirmed -> force AI
        runInsightsBtn.disabled = true;
        runInsightsBtn.textContent = 'Runningâ€¦';
        try{
          const r = await fetch('/api/agents/insights/run', {method:'POST', credentials:'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({force_ai: true})});
          let j;
          try{ j = await r.json(); } catch(e){ const txt = await r.text().catch(()=>null); j = { error: txt || 'invalid json' }; }
          await loadDashboard();
          if(j.result && !j.result.error) {
            alert('Insights updated (AI)');
          } else {
            alert('Insights run returned error: ' + (j.result && j.result.error ? j.result.error : JSON.stringify(j)));
          }
        }catch(e){
          alert('Failed to run insights agent: ' + e);
        } finally {
          runInsightsBtn.disabled = false;
          runInsightsBtn.textContent = 'Run Insights';
        }
      });
    }

    // Run Forecast button handler
    const runForecastBtn = document.getElementById('run-forecast');
    if(runForecastBtn){
      runForecastBtn.addEventListener('click', async function(){
        runForecastBtn.disabled = true;
        runForecastBtn.textContent = 'Runningâ€¦';
        try{
          const r = await fetch('/api/agents/forecast/run', {method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
          let j;
          try{ j = await r.json(); } catch(e){ const txt = await r.text().catch(()=>null); j = { error: txt || 'invalid json' }; }
          await loadDashboard();
          if(j.result && !j.result.error) {
            alert('Forecast updated');
          } else {
            alert('Forecast run returned error: ' + (j.result && j.result.error ? j.result.error : JSON.stringify(j)));
          }
        }catch(e){
          alert('Failed to run forecast agent: ' + e);
        } finally {
          runForecastBtn.disabled = false;
          runForecastBtn.textContent = 'Run Forecast';
        }
      });
    }

    // Debug panel: toggle and fetch raw API JSON to help diagnose missing values
    const toggleDebugBtn = document.getElementById('toggle-debug');
    const debugPanel = document.getElementById('debug-panel');
    if(toggleDebugBtn && debugPanel){
      toggleDebugBtn.addEventListener('click', async function(){
        if(debugPanel.style.display === 'none'){
          debugPanel.textContent = 'Loading API responses...';
          try{
            // first, check authentication/debug info
            let whoami = null;
            try{
              whoami = await fetchJson('/_debug/whoami');
            }catch(e){ whoami = { error: String(e) }; }

            const endpoints = ['/api/dashboard/summary','/api/transactions/recent','/api/notifications/json'];
            const results = {};
            for(const ep of endpoints){
              try{
                const r = await fetch(ep, { credentials: 'same-origin' });
                if(!r.ok){
                  results[ep] = { ok:false, status: r.status, statusText: r.statusText };
                  try{ results[ep].body = await r.text(); }catch(e){}
                } else {
                  try{
                    const body = await r.json();
                    results[ep] = { ok:true, status: r.status, body };
                  }catch(e){
                    results[ep] = { ok:true, status: r.status, body_text: await r.text() };
                  }
                }
              }catch(err){
                results[ep] = { ok:false, error: String(err) };
              }
            }

            const out = { whoami, results };
            debugPanel.textContent = JSON.stringify(out, null, 2);
          }catch(e){
            debugPanel.textContent = 'Debug fetch failed: ' + String(e);
          }
          debugPanel.style.display = 'block';
          toggleDebugBtn.textContent = 'Hide API';
        } else {
          debugPanel.style.display = 'none';
          toggleDebugBtn.textContent = 'Show API';
        }
      });
    }

  </script>
</body>
</html>