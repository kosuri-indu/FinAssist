<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notifications</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
 </head>
<body>
    {% include 'sidebar.html' %}

    <main class="main-content ml-72 p-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-3xl font-extrabold text-gray-900">Notifications</h1>
            <p class="text-sm text-gray-600">Recent alerts, reminders and messages about your account.</p>
          </div>
          <div class="flex items-center gap-2">
            <a href="/agents" class="text-sm px-3 py-1 bg-gray-100 rounded">Agents Center</a>
            <button id="refresh-summary" class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition">Refresh Summary</button>
          </div>
        </div>
        <div id="agent-summary-container">
        {% if agent_summary %}
          {# agent_summary may be a dict with message/details or a plain string; handle both #}
          {% if agent_summary is mapping %}
            <div class="mb-4 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üí∞</span>
                  <div class="text-base font-bold text-gray-900">Payment Intelligence</div>
                </div>
                <div class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded font-medium">Smart Analysis</div>
              </div>

              <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white rounded-lg p-3 border-2 border-blue-300">
                  <div class="text-xs text-gray-600 mb-1">Total Due</div>
                  <div class="text-2xl font-bold text-blue-600">‚Çπ{{ "{:,.0f}".format(agent_summary.details.total_rupees) }}</div>
                </div>
                <div class="bg-white rounded-lg p-3 border-2 border-gray-300">
                  <div class="text-xs text-gray-600 mb-1">Bills Count</div>
                  <div class="text-2xl font-bold text-gray-700">{{ agent_summary.details.count }}</div>
                </div>
              </div>

              <div id="agent-summary-message" class="formatted-message"></div>
              <script>
                (function(){
                  const msgEl = document.getElementById('agent-summary-message');
                  if(msgEl){
                    const raw = {{ agent_summary.message|tojson }};
                    msgEl.innerHTML = formatMessage(raw);
                  }
                })();
              </script>
            </div>
          {% else %}
            <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
              <div class="text-sm font-semibold text-blue-800">Smart Reminder</div>
              <div class="text-sm text-blue-700 mt-2">{{ agent_summary }}</div>
            </div>
          {% endif %}
        {% endif %}
        </div>

        <div class="space-y-3">
          {% if notifications is defined and notifications|length > 0 %}
            {% for n in notifications %}
            <div class="flex items-center gap-4 bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition" id="notif-{{ n.id }}">
              <div class="flex-shrink-0">
                {% if n.type == 'reminder' %}
                  <div class="h-12 w-12 rounded-md bg-yellow-100 flex items-center justify-center text-yellow-800 text-xl">üí≥</div>
                {% elif n.type == 'alert' %}
                  <div class="h-12 w-12 rounded-md bg-red-100 flex items-center justify-center text-red-800 text-xl">‚ö†Ô∏è</div>
                {% else %}
                  <div class="h-12 w-12 rounded-md bg-blue-100 flex items-center justify-center text-blue-800 text-xl">‚ÑπÔ∏è</div>
                {% endif %}
              </div>
              <div class="flex-1">
                <div class="text-sm font-semibold text-gray-800">{{ n.title }}</div>
                <div class="text-xs text-gray-500 mt-1">{{ n.created_at }}</div>
              </div>
              <div class="text-right mr-4">
                <div class="text-2xl font-bold text-gray-900">‚Çπ{{ n.body.split('‚Çπ')[1].split()[0] if '‚Çπ' in n.body else '0' }}</div>
                <div class="text-xs text-gray-500 mt-1">{{ n.body.split('Due:')[1].split('‚Ä¢')[0].strip() if 'Due:' in n.body else '' }}</div>
              </div>
              <div class="flex-shrink-0">
                {% if n.type == 'reminder' %}
                <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition" onclick="markPaid('{{ n.id }}')" style="cursor: pointer;">‚úì Mark Paid</button>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="bg-white rounded-lg shadow-sm p-6">
              <p class="text-sm text-gray-600">No notifications yet. We'll show reminders and alerts here.</p>
            </div>
          {% endif %}
        </div>
    </main>
    <script>
      // Preserve summary when switching tabs/pages
      let cachedSummaryHTML = null;
      
      function saveSummaryToCache(){
        const container = document.getElementById('agent-summary-container');
        if(container){
          cachedSummaryHTML = container.innerHTML;
          sessionStorage.setItem('finassist_summary_cache', cachedSummaryHTML);
        }
      }
      
      function restoreSummaryFromCache(){
        const container = document.getElementById('agent-summary-container');
        if(container && cachedSummaryHTML){
          container.innerHTML = cachedSummaryHTML;
        }
      }
      
      // Save summary before unloading
      window.addEventListener('beforeunload', saveSummaryToCache);
      
      function initializeNotificationHandlers(){
        const refreshBtn = document.getElementById('refresh-summary');
        if(refreshBtn){
          // Remove all old listeners
          const newBtn = refreshBtn.cloneNode(true);
          refreshBtn.parentNode.replaceChild(newBtn, refreshBtn);
          // Add new listener
          newBtn.addEventListener('click', onRefreshSummary);
        }
        
        const markPaidBtns = document.querySelectorAll('button[onclick*="markPaid"]');
        markPaidBtns.forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          const onclickStr = newBtn.getAttribute('onclick');
          const match = onclickStr.match(/'([^']+)'/);
          if(match){
            const billId = match[1];
            newBtn.addEventListener('click', (e) => {
              e.preventDefault();
              markPaid(billId);
            });
            newBtn.removeAttribute('onclick');
          }
        });
      }
      
      function onRefreshSummary(e){
        e.preventDefault();
        fetchSummary(false);
      }
      
      // Setup page load hook properly
      (function(){
        const previousOnPageLoad = window.onPageLoad;
        window.onPageLoad = function(){
          // Call previous handler if it exists
          if(typeof previousOnPageLoad === 'function'){
            try { previousOnPageLoad(); } catch(e) { console.warn('Previous onPageLoad error:', e); }
          }
          restoreSummaryFromCache();
          initializeNotificationHandlers();
        };
      })();
      
      // Initialize on initial load
      initializeNotificationHandlers();
      
      // Restore from cache if available
      try {
        const cached = sessionStorage.getItem('finassist_summary_cache');
        if(cached){
          const container = document.getElementById('agent-summary-container');
          if(container){
            container.innerHTML = cached;
            cachedSummaryHTML = cached;
          }
        }
      } catch(e) {
        console.warn('Could not restore summary cache:', e);
      }
      function formatMessage(text){
        if(!text) return '';
        
        // Split by double newlines to get sections
        const sections = text.split('\n\n');
        let html = '';
        
        sections.forEach((section, idx) => {
          // Replace **text** with <strong>text</strong>
          section = section.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-bold text-gray-900">$1</strong>');
          
          // Check if section starts with a heading (bold text followed by colon)
          const headingMatch = section.match(/^<strong[^>]*>([^<]+):<\/strong>/);
          if(headingMatch) {
            // This is a section with a heading
            const heading = headingMatch[0];
            const content = section.substring(heading.length).trim();
            html += `<div class="mb-4 p-4 bg-white rounded-lg border-l-4 ${getSectionColor(idx)} shadow-sm">
              <div class="text-sm font-bold text-gray-800 mb-2">${heading.replace(':', '')}</div>
              <div class="text-sm text-gray-700 leading-relaxed">${content}</div>
            </div>`;
          } else {
            // Regular paragraph
            html += `<div class="mb-3 text-sm text-gray-700 leading-relaxed">${section}</div>`;
          }
        });
        
        return html;
      }
      
      // Get color scheme for different section types
      function getSectionColor(index) {
        const colors = [
          'border-red-400',    // Overview/Urgent
          'border-blue-400',   // Priority
          'border-purple-400', // Largest
          'border-green-400'   // Strategy
        ];
        return colors[index % colors.length] || 'border-gray-400';
      }

      // Global toast function
      function showToast(msg){
        try{
          const t = document.createElement('div');
          t.textContent = msg;
          t.className = 'fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-2 rounded shadow z-50';
          document.body.appendChild(t);
          setTimeout(()=>{ t.remove(); }, 3500);
        }catch(e){ console.warn(e); }
      }

      // Global fetchSummary function (used by both button and mark paid)
      let refreshBtn = null;
      let container = null;
      
      async function fetchSummary(force){
        refreshBtn = refreshBtn || document.getElementById('refresh-summary');
        container = container || document.getElementById('agent-summary-container');
          const btn = refreshBtn;
          if(btn) btn.disabled = true;
          const origText = btn ? btn.textContent : '';
          if(btn) btn.textContent = 'Refreshing‚Ä¶';
          try{
            const body = force ? JSON.stringify({force_ai:true}) : JSON.stringify({});
            const r = await fetch('/api/agents/reminders/run', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body});
            const j = await r.json().catch(()=>({error:'invalid json'}));
            if(!r.ok){
              showToast('Summary request failed');
              console.error('summary fetch failed', r.statusText, j);
              return;
            }
            if(j.result && j.result.error){
              showToast('Summary error: ' + j.result.error);
              return;
            }
            const res = j.result;
            // render inline
            if(!container) return;
            let html = '';
            if(res){
              if(typeof res === 'string'){
                html = `<div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded"><div class="text-sm font-semibold text-blue-800">Smart Reminder</div><div class="text-sm text-blue-700 mt-2">${res}</div></div>`;
              } else {
                const total = (res.details && res.details.total_rupees) ? res.details.total_rupees : 0;
                const count = (res.details && typeof res.details.count !== 'undefined') ? res.details.count : (res.bills?res.bills.length:0);
                html = `<div class="mb-4 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm">`+
                       `<div class="flex items-start justify-between mb-3"><div class="flex items-center gap-2"><span class="text-2xl">üí∞</span><div class="text-base font-bold text-gray-900">Payment Intelligence</div></div><div class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded font-medium">Smart Analysis</div></div>`+
                       `<div class="grid grid-cols-2 gap-3 mb-4">`+
                       `<div class="bg-white rounded-lg p-3 border-2 border-blue-300"><div class="text-xs text-gray-600 mb-1">Total Due</div><div class="text-2xl font-bold text-blue-600">‚Çπ${total.toLocaleString('en-IN')}</div></div>`+
                       `<div class="bg-white rounded-lg p-3 border-2 border-gray-300"><div class="text-xs text-gray-600 mb-1">Bills Count</div><div class="text-2xl font-bold text-gray-700">${count}</div></div>`+
                       `</div>`+
                       `<div class="formatted-message">${formatMessage(res.message || '')}</div>`+
                       `</div>`;
                if(res.ai_message){
                  html += `<div class="mt-3 p-3 bg-white border-l-4 border-purple-400 rounded text-sm text-gray-800"><strong class="text-purple-700">AI Enhancement:</strong> ${res.ai_message}</div>`;
                }
              }
            }
            container.innerHTML = html;
            saveSummaryToCache();
            showToast('Summary updated');
          }catch(e){
            console.error(e);
            showToast('Request failed');
          } finally {
            if(btn) { btn.disabled = false; btn.textContent = origText; }
          }
      }

      // Mark paid button handler
      async function markPaid(billId){
        try {
          console.log('Marking bill as paid:', billId);
          const res = await fetch(`/notifications/${billId}/mark_done`, {method: 'POST', credentials: 'same-origin'});
          const data = await res.json();
          console.log('Mark paid response:', data);
          
          if(!data.ok){
            showToast('‚ùå ' + (data.error || 'Failed to mark bill as paid'));
            return;
          }
          
          // Remove the notification from DOM with fade out
          const elem = document.getElementById(`notif-${billId}`);
          if(elem){
            elem.style.transition = 'all 0.3s ease';
            elem.style.opacity = '0';
            elem.style.transform = 'translateX(20px)';
            setTimeout(()=>{ 
              elem.remove();
              // Check if no more notifications, show empty state
              const notifContainer = document.querySelector('.space-y-3');
              if(notifContainer && notifContainer.children.length === 0){
                notifContainer.innerHTML = '<div class="bg-white rounded-lg shadow-sm p-6"><p class="text-sm text-gray-600">No notifications yet. We\'ll show reminders and alerts here.</p></div>';
              }
            }, 300);
          }
          showToast('‚úÖ Bill marked as paid!');
          // Clear cached insights/forecast since data changed
          localStorage.removeItem('finassist_insights_cache');
          localStorage.removeItem('finassist_forecast_cache');
          // Refresh AI analysis after marking paid
          setTimeout(() => fetchSummary(false), 500);
        } catch(e) {
          console.error('markPaid error:', e);
          showToast('‚ùå Failed to mark bill as paid');
        }
      }
    </script>
  </body>
</html>
